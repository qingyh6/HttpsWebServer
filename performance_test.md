| æµ‹è¯•ç±»å‹    | å·¥å…·             | åœºæ™¯è¯´æ˜                           |
| ------- | -------------- | ------------------------------ |
| æ¥å£åŠŸèƒ½æµ‹è¯•  | Postman / curl/jmeter| æµ‹è¯• Range è¿”å›ã€é‰´æƒæ ¡éªŒç­‰é€»è¾‘æ˜¯å¦æ­£ç¡®        |
| å•æ¥å£æ€§èƒ½æµ‹è¯• | ab             | æµ‹è¯•å¤§æ–‡ä»¶å…¨é‡ä¸‹è½½çš„å¸¦å®½å’Œååæé™ï¼ˆä½†ä¸é€‚åˆæµ‹ Rangeï¼‰ |
| åœºæ™¯å¹¶å‘æµ‹è¯•  | JMeter         | æ¨¡æ‹Ÿæ’­æ”¾å™¨å¹¶å‘æ‹‰æµåœºæ™¯ï¼Œé€å—ä¸‹è½½è§†é¢‘ï¼Œæµ‹ Range é€»è¾‘  |

## å¦‚ä½•é¿å…é‰´æƒ
åœ¨é¡¹ç›®çš„åŠŸèƒ½æ¨¡å—ä¸­ï¼Œæ˜¯é€šè¿‡ä¼šè¯ç®¡ç†æ¥ç¡®ä¿ç”¨æˆ·ç™»å½•äº†çš„ã€‚ä½†æ˜¯ä¸ºäº†æ€§èƒ½æµ‹è¯•ï¼Œä¸å¯èƒ½æ¨¡æ‹Ÿæ¯ä¸€ä¸ªçœŸå®ç”¨æˆ·ï¼ˆåˆ›å»ºä¸åŒçš„è´¦å·ï¼‰æ¥è®¿é—®ï¼Œå®é™…ä¸Šåœ¨æœ¬é¡¹ç›®çº¦å®šäº†ä¸€ä¸ªå­—æ®µï¼Œåªæœ‰åœ¨è¯·æ±‚å¤´ä¸­å¸¦ä¸Šå­—æ®µ**TestBypass=perf-token**ï¼Œå°±å¯ä»¥æœ‰æ•ˆåœ°è·³è¿‡é‰´æƒï¼Œè€Œä¸“æ³¨äºåœ¨æœåŠ¡å™¨ä¸­æ¯”è¾ƒå®¹æ˜“å‡ºç°ç“¶é¢ˆçš„åœ°æ–¹ã€‚åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæ¯”è¾ƒå®¹æ˜“å‡ºç°ç“¶é¢ˆçš„åœ°æ–¹æœ‰è§†é¢‘çš„æ’­æ”¾ï¼ˆåŒä¸€æ—¶åˆ»å¤§é‡ç”¨æˆ·è¯·æ±‚ï¼‰ï¼Œå¤§æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç­‰ï¼Œè¿™äº›ç­‰éƒ½æ˜¯å¯èƒ½å¼•èµ·æ€§èƒ½ç“¶é¢ˆçš„åœ°æ–¹ï¼Œæµ‹è¯•æ—¶ä¹Ÿæ˜¯ä¸»è¦å…³æ³¨è¿™äº›éƒ¨åˆ†çš„ã€‚
  ```c++
    auto session = server_->getSessionManager()->getSession(req, resp);
    bool isTestBypass = false;
    std::string bypassHeader = req.getHeader("TestBypass"); //å¦‚æœæ˜¯æµ‹è¯•çš„è¯ï¼Œåœ¨å‘é€è¯·æ±‚æ—¶å¸¦ä¸Šè¿™ä¸ªå­—æ®µå°±å¯ä»¥
    if (bypassHeader == "perf-token") {
        LOG_INFO << "[PerfTest] Bypassing login check.";
        isTestBypass = true;
    }

    if (session->getValue("isLoggedIn") != "true" && !isTestBypass) {
        json errorResp;
        errorResp["status"] = "error";
        errorResp["message"] = "Unauthorized";
        std::string errorBody = errorResp.dump();
        server_->packageResp(req.getVersion(), http::HttpResponse::k401Unauthorized,
                            "Unauthorized", true, "application/json",
                            errorBody.size(), errorBody, resp);
        return;
    }
  ```
## æ¥å£åŠŸèƒ½æµ‹è¯•
è¿™é‡Œæµ‹è¯•çš„æ˜¯è§†é¢‘çš„Rangeå­—æ®µè¯·æ±‚æ˜¯å¦æœ‰æ•ˆï¼Œè§†é¢‘æ’­æ”¾åŠŸèƒ½
åˆ†æå¦‚ä¸‹ï¼Œæ¨¡æ‹Ÿäº†50ä¸ªçº¿ç¨‹ï¼ˆæ¨¡æ‹Ÿç”¨æˆ·ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹å‘é€20æ¬¡è¯·æ±‚ï¼Œåœ¨10ç§’å†…å‘é€æ‰€æœ‰è¯·æ±‚ï¼ˆ50*20=1000æ¬¡è¯·æ±‚ï¼‰ã€‚
![å•èŒƒå›´æŸ¥è¯¢](https://github.com/user-attachments/assets/0345c1fa-4550-404d-8c8c-b6b84e1d2c65)

éšåå¼€äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œä¾æ¬¡è¯·æ±‚0~3000ï¼Œ3000~8000ï¼Œ8000~16000ï¼Œ16000~20000ï¼Œ20000~30000çš„rangeèŒƒå›´çš„æ•°æ®ï¼ˆè®¾ç½®çš„æ¯æ¬¡è¯·æ±‚çš„èŒƒå›´å­—æ®µä¸ä¸€æ ·ï¼‰
![å¤šèŠ‚ç‚¹è®¿é—®æŸ¥è¯¢](https://github.com/user-attachments/assets/a54a5903-9914-4a5d-bd95-ebbefc0a9156)


## å•æ¥å£æ€§èƒ½æµ‹è¯•
ğŸ“Š æµ‹è¯•å¯¹æ¯”æ€»è§ˆï¼š
| æŒ‡æ ‡é¡¹           | å¤§è§†é¢‘ (86MB)                | å°è§†é¢‘ (7.9MB)             |
| ------------- | ------------------------- | ----------------------- |
| è¯·æ±‚æ€»æ•° (`-n`)   | 1000                      | 1000                    |
| å¹¶å‘æ•° (`-c`)    | 100                       | 100                     |
| æ€»è€—æ—¶           | **556 ç§’**                 | **20 ç§’**                |
| å¹³å‡ RPSï¼ˆè¯·æ±‚æ•°/ç§’ï¼‰ | **1.80 req/s**            | **49.60 req/s**         |
| å¹³å‡æ¯ä¸ªè¯·æ±‚è€—æ—¶ï¼ˆæ€»è§†è§’ï¼‰ | **55654 ms / req**        | **2016 ms / req**       |
| å¹³å‡æ¯ä¸ªè¯·æ±‚è€—æ—¶ï¼ˆå•è¯·æ±‚ï¼‰ | **556.5 ms / req**        | **20.16 ms / req**      |
| æœ€å¤§è¯·æ±‚è€—æ—¶        | **318,324 msï¼ˆè¶… 5 åˆ†é’Ÿï¼‰**    | **3052 ms**             |
| ä¼ è¾“é€Ÿç‡          | 151 MB/s                  | 375 MB/s                |
| è¯·æ±‚å¤±è´¥          | 0                         | 0                       |

å¯¹è‡ªç ” HttpServer æ¡†æ¶çš„è§†é¢‘æ¥å£è¿›è¡Œäº†æ€§èƒ½å‹æµ‹ï¼Œé€šè¿‡ Apache Benchmark å·¥å…·åˆ†åˆ«å¯¹å°è§†é¢‘ï¼ˆ8MBï¼‰ä¸å¤§è§†é¢‘ï¼ˆ86MBï¼‰è¿›è¡Œ 100 å¹¶å‘ã€1000 è¯·æ±‚çš„å…¨æµç¨‹ä¸‹è½½æµ‹è¯•ï¼Œæµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š\
é«˜å¹¶å‘ä¸‹çš„è§†é¢‘æ¥å£ç¨³å®šæ€§å’Œèµ„æºåˆ©ç”¨ï¼›\
ä½¿ç”¨ Header è®¾è®¡ç»•è¿‡é‰´æƒé€»è¾‘ï¼Œå®ç°çº¯å‡€æ€§èƒ½æµ‹è¯•ï¼›\
æ•è·è§†é¢‘æ–‡ä»¶è¯»å–ã€å“åº”æ—¶é—´ã€ååé‡ç­‰å…³é”®æŒ‡æ ‡ï¼›\
å¯¹å¤§è§†é¢‘è¯·æ±‚ä¸­æš´éœ²çš„ CPU å†…å­˜å ç”¨é«˜ã€I/O é˜»å¡ã€è¯·æ±‚é•¿å°¾ç­‰ç“¶é¢ˆç‚¹è¿›è¡Œé€æ­¥ä¼˜åŒ–ã€‚\
\
âœ… æµ‹è¯•ç»“æœï¼šå°æ–‡ä»¶æ¥å£å¤„ç†é€Ÿç‡çº¦ 49 req/sï¼Œæ€»è€—æ—¶ 20sï¼›å¤§æ–‡ä»¶æ¥å£å¤„ç†é€Ÿç‡çº¦ 1.8 req/sï¼Œæ€»è€—æ—¶è¾¾ 556sã€‚

ä¸‹é¢æ˜¯é€šè¿‡Apache Bench (ab) å‹æµ‹çš„å…·ä½“æˆªå›¾
æµ‹è¯•å°è§†é¢‘æ–‡ä»¶çš„æ’­æ”¾ï¼ˆ7.9Mï¼‰
  ```shell
  ab -n 1000 -c 100  -H "TestBypass:perf-token" http://192.168.218.128/videos/test.mp4
  ```
<img width="846" height="591" alt="image" src="https://github.com/user-attachments/assets/beade982-b420-4549-b838-036c8f30662a" />

æµ‹è¯•å¤§è§†é¢‘æ–‡ä»¶çš„æ’­æ”¾(86M)
 ```shell
  ab -n 1000 -c 100  -H "TestBypass:perf-token" http://192.168.218.128/videos/safe%20and%20sound.mp4
  ```
<img width="672" height="697" alt="image" src="https://github.com/user-attachments/assets/4dc08af0-86f5-4877-9cf1-11ba956ccb24" />


## åœºæ™¯å¹¶å‘æµ‹è¯•
