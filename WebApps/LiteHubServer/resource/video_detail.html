<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è§†é¢‘è¯¦æƒ…</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f7f8fa; }
    .video-section { padding: 20px; text-align: center; background: #fff; }
    .comment-section { padding: 20px; }
     .comment-input-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #comment-input {
      flex: 1;
      height: 30px;
      resize: none;
      padding: 5px;
      font-size: 16px;
    }
    #submit-comment {
      display: none; /* åˆå§‹éšè— */
      height: 30px;
      /* padding: 0 12px; */
      padding :5px;
      font-size: 16px;
      cursor: pointer;
    }
    textarea { width: 100%; height: 20px; margin-bottom: 10px; }
    /* .comment { background: #fff; 
      padding: 10px 15px;
       margin: 10px 0; 
       border-radius: 6px; 
       box-shadow: 0 2px 6px rgba(0,0,0,0.05); } */
      .comment { 
          padding: 10px 0;
        } 
      .comment.root {
      border-bottom: 1px solid #eee;
    }
    .comment .meta { font-size: 12px; color: #666; }
    .comment .content {
      font-size: 14px;
      margin: 6px 0;
    }

    .reply-btn {
      font-size: 12px;
      color: #007bff;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }

    .reply-btn:hover {
      text-decoration: underline;
      color: #0056b3;
    }


  </style>
</head>
<body>
  <div class="video-section">
    <video id="video-player" controls width="80%">
      <source id="video-source" src="" type="video/mp4" />
    </video>
    <div id="video-title" style="margin-top: 10px; font-weight: bold;"></div>
  </div>

  <div id="video-stats" style="margin: 15px 0; background: #fff; padding: 10px; border-radius: 6px;">
    <span id="view-count">æ’­æ”¾é‡: 0</span> |
    <span id="like-count">ç‚¹èµæ•°: 0</span>
    <button id="like-btn" style="margin-left: 10px;">ç‚¹èµ ğŸ‘</button>
  </div>

  <div class="comment-section">
    <h3>è¯„è®ºåŒº</h3>
    <div class="comment-input-wrapper">
      <textarea id="comment-input" placeholder="ç•™ä¸‹ä½ çš„è¯„è®º..."></textarea>
      <button id="submit-comment">å‘è¡¨è¯„è®º</button>
    </div>
    <div id="comment-list"></div>
  </div>

  <script>
    let currentReplyForm = null; // å…¨å±€å˜é‡ï¼Œè®°å½•å½“å‰çš„å›å¤æ¡†
    const videoName = decodeURIComponent(window.location.pathname.split('/').pop());
    document.getElementById('video-source').src = `/videos/${videoName}`;
    document.getElementById('video-player').load();
    console.log(videoName);


     const commentInput = document.getElementById('comment-input');
    const submitButton = document.getElementById('submit-comment');

    commentInput.addEventListener('focus', () => {
      submitButton.style.display = 'inline-block';
    });

    document.getElementById('like-btn').addEventListener('click', () => {
      fetch(`/video/like`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          videoName: videoName,
          option: option   //"query"/"like"/"unlike"
        })
      }).then(res => {
        if (res.ok) updateStats();
        else alert('ç‚¹èµæ“ä½œå¤±è´¥');
      });
    });


    function loadComments() {
      console.log("åŠ è½½è¯„è®ºå•¦");
      fetch(`/video/get_comments/${(videoName)}`)
        .then(res => res.json())
        .then(comments => {
          const list = document.getElementById('comment-list');
          list.innerHTML = '';
          comments.forEach(c => {
            list.appendChild(renderComment(c,true));
          });
        });
    }

    // é€’å½’æ¸²æŸ“è¯„è®ºå’Œå›å¤æ¡†
    function renderComment(comment, isRoot = false) {
        const div = document.createElement('div');
        // div.className = 'comment';
        // div.className = 'comment root'; // å¯¹äº parent_id = 0 çš„è¯„è®º
        div.className = isRoot ? 'comment root' : 'comment'; // ä»…ä¸»è¯„è®ºåŠ  root ç±»

        // è¯„è®ºHTMLç»“æ„
        div.innerHTML = `
          <div class="meta"><strong>${comment.user_name}</strong></div>
          <div class="content">${comment.content}</div>
          <div class="meta">
            ${comment.created_at} 
            <button class="reply-btn">å›å¤</button>
          </div>
        `;

        // æ·»åŠ å›å¤æŒ‰é’®é€»è¾‘
        const replyBtn = div.querySelector('.reply-btn');
          replyBtn.addEventListener('click', (e) => {
              e.stopPropagation(); // é˜²æ­¢å†’æ³¡å½±å“ document çš„ click ç›‘å¬

              // å¦‚æœå·²æœ‰å›å¤æ¡†ï¼Œå…ˆç§»é™¤
              if (currentReplyForm) {
                currentReplyForm.remove();
                currentReplyForm = null;
              }

              // å¦‚æœå½“å‰è¯„è®ºä¸‹å·²ç»æœ‰ reply-formï¼Œå°±ä¸å†æ·»åŠ 
              if (div.querySelector('.reply-form')) return;

              const replyForm = document.createElement('div');
              replyForm.className = 'reply-form';
              replyForm.style.marginTop = '10px';
              replyForm.innerHTML = `
                <input type="text" class="reply-input" placeholder="è¾“å…¥å›å¤å†…å®¹" style="width: 80%; padding: 4px;" />
                <button class="submit-reply" style="padding: 4px 10px;">æäº¤</button>
              `;
              div.appendChild(replyForm);
              currentReplyForm = replyForm; // è®°å½•å½“å‰å›å¤æ¡†

              const submitBtn = replyForm.querySelector('.submit-reply');
              submitBtn.addEventListener('click', () => {
                const content = replyForm.querySelector('.reply-input').value.trim();
                if (!content) return;

                const replyData = {
                  videoName: videoName,
                  parent_id: comment.id,
                  content: content
                };

                fetch('/video/push_comments', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(replyData)
                }).then(response => {
                  if (response.ok) {
                    loadComments(); // åˆ·æ–°è¯„è®ºåŒº
                  } else {
                    alert('å›å¤å¤±è´¥');
                  }
                });
              });
            });

            // ç›‘å¬ç‚¹å‡»ç©ºç™½å¤„å…³é—­å›å¤æ¡†
            document.addEventListener('click', (e) => {
              if (
                currentReplyForm &&
                !e.target.closest('.reply-form') &&
                !e.target.classList.contains('reply-btn')
              ) {
                currentReplyForm.remove();
                currentReplyForm = null;
              }
            });


          // æ¸²æŸ“å­è¯„è®ºï¼ˆé€’å½’ï¼‰
          if (comment.replies && comment.replies.length > 0) {
            const childContainer = document.createElement('div');
            childContainer.style.marginLeft = '20px';
            comment.replies.forEach(reply => {
              childContainer.appendChild(renderComment(reply));
            });
            div.appendChild(childContainer);
          }

          return div;
      }

    // æäº¤è¯„è®ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('submit-comment').addEventListener('click', () => {
      const content = document.getElementById('comment-input').value;
      if (!content.trim()) return;

      const commentData = {
        videoName: videoName,
        // user_id: 1,          // å®é™…ä½¿ç”¨ä¸­åº”ç”± JWT æˆ–ç™»å½•ç³»ç»Ÿæä¾›
        parent_id: 0,        // é¡¶å±‚è¯„è®ºé»˜è®¤æ˜¯ 0
        content: content.trim()
      };

      fetch('/video/push_comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(commentData)
      }).then(response => {
        if (response.ok) {
          document.getElementById('comment-input').value = '';
          loadComments(); // é‡æ–°åŠ è½½è¯„è®º
        } else {
          alert('è¯„è®ºå‘å¸ƒå¤±è´¥');
        }
      });
    });


    function updateStats() {
        fetch(`/video/like`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            videoName: videoName,
            option: "query"
          })
        })
        .then(res => res.json())
        .then(data => {
          // document.getElementById('view-count').innerText = `æ’­æ”¾é‡: ${data.views}`;
          document.getElementById('like-count').innerText = `ç‚¹èµæ•°: ${data.likeCount}`;
          document.getElementById('like-btn').innerText = data.liked ? 'å–æ¶ˆç‚¹èµ ğŸ‘' : 'ç‚¹èµ ğŸ‘';
        });
      }

      document.getElementById('like-btn').addEventListener('click', () => {
            // åˆ¤æ–­å½“å‰æ˜¯ç‚¹èµè¿˜æ˜¯å–æ¶ˆç‚¹èµï¼ˆæ ¹æ®æŒ‰é’®æ–‡å­—æˆ–å˜é‡çŠ¶æ€ï¼‰
            const isLiked = document.getElementById('like-btn').innerText.includes('å–æ¶ˆ');

            fetch(`/video/like`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                videoName: videoName,
                option: isLiked ? "unlike" : "like"
              })
            })
            .then(res => {
              if (res.ok) updateStats();
              else alert('ç‚¹èµæ“ä½œå¤±è´¥');
            });
          });
        
          function increaseViewCount() {
            fetch(`/video/view_counts`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ videoName: videoName })
            })
            .then(res => res.json())
            .then(data=>{
              if(data.view_count!=undefined)
            {
              document.getElementById('view-count').innerText = `æ’­æ”¾é‡: ${data.view_count}`;
            }
            })
            .catch(err => console.error('æ’­æ”¾é‡å¢åŠ å¤±è´¥:', err));
          }

      // åŠ è½½é¡µé¢
      window.addEventListener('load', function() {
          increaseViewCount();  // æ’­æ”¾é‡ +1
          updateStats();  // é¡µé¢åˆå§‹åŒ–æ—¶åˆ·æ–°ç‚¹èµçŠ¶æ€
          loadComments();// ä½ å·²æœ‰çš„è¯„è®ºåŠ è½½å‡½æ•°
      });

  </script>
</body>
</html>
